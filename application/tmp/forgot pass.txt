else
				{
					// Set reset datetime
					$time = $this->account_model->update_reset_sent_datetime($account->id);

					// Load email library
					$this->load->library('email');

					// Set up email preferences
					$config['mailtype'] = 'html';

					// Initialise email lib
					$this->email->initialize($config);

					// Generate reset password url
					$password_reset_url = site_url('account/reset_password?id='.$account->id.'&token='.sha1($account->id.$time.$this->config->item('password_reset_secret')));

					// Send reset password email
					$this->email->from($this->config->item('password_reset_email'), lang('reset_password_email_sender'));
					$this->email->to($account->email);
					$this->email->subject(lang('reset_password_email_subject'));
					$this->email->message($this->load->view('account/reset_password_email', array(
						'username' => $account->username,
						'password_reset_url' => anchor($password_reset_url, $password_reset_url)
					), TRUE));
					if($this->email->send())
					{
						// Load reset password sent view
						$this->load->view('account/reset_password_sent', isset($data) ? $data : NULL);
					}
					else
					{
						//if the email could not be sent it will display the error
						//should not happen if you have email configured correctly
						echo $this->email->print_debugger();
					}
					return;
				}
                
                
                
                
// Get account by email
		if ($account = $this->account_model->get_by_id($this->input->get('id')))
		{
			// Check if reset password has expired
			if (now() < (strtotime($account->resetsenton) + $this->config->item("password_reset_expiration")))
			{
				// Check if token is valid
				if ($this->input->get('token') == sha1($account->id.strtotime($account->resetsenton).$this->config->item('password_reset_secret')))
				{
					// Remove reset sent on datetime
					$this->account_model->remove_reset_sent_datetime($account->id);

					// Upon sign in, redirect to change password page
					$this->session->set_userdata('sign_in_redirect', 'account/account_password');

					// Run sign in routine
					$this->authentication->sign_in($account->id);
				}
			}
		}